<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web3 OAuth Client Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            padding: 12px 24px;
            margin: 10px 5px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .primary { background-color: #512da8; color: white; }
        .secondary { background-color: #1976d2; color: white; }
        .danger { background-color: #d32f2f; color: white; }
        .info-box {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 15px 0;
        }
        .success-box {
            background-color: #e8f5e8;
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin: 15px 0;
        }
        .error-box {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
            padding: 15px;
            margin: 15px 0;
        }
        .config-section {
            margin: 20px 0;
            padding: 20px;
            background-color: #fff3e0;
            border-left: 4px solid #fb8c00;
            border-radius: 8px;
        }
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .level-card {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 18px;
            margin-bottom: 15px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        }
        .level-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        .level-header h3 {
            margin: 0;
            font-size: 18px;
            color: #424242;
        }
        label {
            font-weight: bold;
            display: block;
            margin-bottom: 6px;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
        }
        .token-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 12px;
        }
        .token-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)) auto;
            gap: 10px;
            align-items: end;
        }
        .small-button {
            padding: 8px 12px;
            font-size: 13px;
        }
        .ghost-button {
            background: transparent;
            color: #fb8c00;
            border: 1px dashed #fb8c00;
        }
        .outline-button {
            background: transparent;
            border: 1px solid #bdbdbd;
            color: #424242;
        }
        .outline-button:hover {
            background: #eeeeee;
        }
        .ghost-button:hover {
            background: rgba(251, 140, 0, 0.1);
        }
        .preview-box {
            margin-top: 20px;
            background: #f0f4c3;
            border-left: 4px solid #c0ca33;
            padding: 15px;
            border-radius: 8px;
        }
        .preview-box pre {
            margin: 0;
            overflow-x: auto;
        }
        code {
            background-color: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Web3 OAuth Client Test</h1>
        
        <div class="info-box">
            <strong>Configuraci√≥n de Testing:</strong><br>
            Servidor: <code>${servidorUrl}</code><br>
            API Key: <code>test-api-key-123</code><br>
            API Secret: <code>test-api-secret-456</code>
        </div>

        <div class="config-section">
            <h2>üéØ Configura tus niveles de acceso personalizados</h2>
            <p>A√±ade tantos niveles como quieras, define la red y los tokens requeridos para cada uno. Estos valores viajar√°n dentro del <code>body</code> del request.</p>
            <div id="levels-container"></div>
            <button id="add-level-btn" type="button" class="secondary small-button">‚ûï A√±adir nivel</button>
            <div class="preview-box">
                <strong>Payload de niveles que se enviar√°:</strong>
                <pre id="access-preview">[]</pre>
            </div>
        </div>
        

        <div id="login-section">
            <h2>Iniciar Sesi√≥n con Phantom Wallet</h2>
            <p>Esta demo se conecta realmente a tu Phantom Wallet para autenticaci√≥n Web3.</p>
            <div class="info-box">
                <strong>Requisitos:</strong><br>
                ‚Ä¢ Phantom Wallet instalada en tu navegador<br>
                ‚Ä¢ Al menos 0.00000001 SOL para nivel premium (opcional)<br>
                ‚Ä¢ Conexi√≥n a Internet para validar la firma
            </div>
            <button class="primary" onclick="handleLogin()">üîó Conectar con Phantom Wallet</button>
        </div>

        <div id="authenticated-section" style="display: none;">
            <h2>‚úÖ Sesi√≥n Activa</h2>
            <div class="success-box">
                <p><strong>Nivel de acceso:</strong> <span id="access-level">-</span></p>
                <p><strong>Access Token:</strong> <span id="token-status">-</span></p>
            </div>
            
            <h3>üí∞ Respuesta del Servidor</h3>
            <pre id="server-response" style="background: #f0f0f0; padding: 15px; border-radius: 5px; overflow-x: auto;"></pre>
            
            <div>
                <button class="secondary" onclick="handleRefresh()">üîÑ Refrescar Token</button>
                <button class="secondary" onclick="handleVerify()">‚úÖ Verificar Token</button>
                <button class="danger" onclick="handleLogout()">üö™ Cerrar Sesi√≥n</button>
            </div>
        </div>

        <div id="status"></div>
    </div>

    <script>

        servidorUrl = 'https://6jr5bxch-3001.usw3.devtunnels.ms';
        const levelsContainer = document.getElementById('levels-container');
        const addLevelBtn = document.getElementById('add-level-btn');
        const accessPreviewEl = document.getElementById('access-preview');
        let customLevelsState = [];

        // SDK Web3OAuth con conexi√≥n real a Phantom Wallet
        class Web3OAuth {
            constructor(apiKey, apiSecret, apiUrl) {
                this.apiKey = apiKey;
                this.apiSecret = apiSecret;
                this.apiUrl = apiUrl;
                this.accessToken = null;
                this.refreshToken = null;
                this.connectedPublicKey = null;
                this.customAccessLevels = [];
            }

            generateSignature(payload) {
                const nonce = Date.now().toString();
                const message = JSON.stringify(payload) + nonce;
                const signature = CryptoJS.HmacSHA256(message, this.apiSecret).toString(CryptoJS.enc.Base64);
                return { signature, nonce };
            }

            setCustomAccessLevels(accessLevels = []) {
                this.customAccessLevels = Array.isArray(accessLevels) ? accessLevels : [];
            }

            async connectWallet() {
                if (!window.solana) {
                    throw new Error('Phantom Wallet no encontrada. Por favor instala Phantom desde https://phantom.app/');
                }

                try {
                    const response = await window.solana.connect();
                    this.connectedPublicKey = response.publicKey.toString();
                    alert(`Wallet conectada: ${this.connectedPublicKey}`);
                    return this.connectedPublicKey;
                } catch (error) {
                    throw new Error(`Error conectando a Phantom: ${error.message}`);
                }
            }

            async authenticate(publicKey) {
                const message = `Autenticaci√≥n para ${this.apiKey} en ${new Date().toISOString()}`;
                
                try {
                    // Firmar mensaje con Phantom Wallet
                    const encodedMessage = new TextEncoder().encode(message);
                    const signedMessage = await window.solana.signMessage(encodedMessage, 'utf8');
                    
                    const payload = {
                        apiKey: this.apiKey,
                        publicKey,
                        signature: Array.from(signedMessage.signature), // Convertir a array
                        message,
                        accessLevels: this.customAccessLevels,
                    };

                    const { signature: hmacSignature, nonce } = this.generateSignature(payload);

                    const response = await fetch(`${this.apiUrl}/api/authenticate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': this.apiKey,
                            'X-Nonce': nonce,
                            'X-Signature': hmacSignature,
                        },
                        body: JSON.stringify(payload),
                    });

                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || `HTTP error! status: ${response.status}`);
                    }

                    this.accessToken = data.accessToken;
                    this.refreshToken = data.refreshToken;
                    return data;
                } catch (error) {
                    throw new Error(`Error en autenticaci√≥n: ${error.message}`);
                }
            }

            async refresh() {
                if (!this.refreshToken) {
                    throw new Error('No hay refresh token disponible');
                }

                const payload = {
                    apiKey: this.apiKey,
                    refreshToken: this.refreshToken,
                    accessLevels: this.customAccessLevels,
                };
                const { signature: hmacSignature, nonce } = this.generateSignature(payload);

                try {
                    const response = await fetch(`${this.apiUrl}/api/refresh`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': this.apiKey,
                            'X-Nonce': nonce,
                            'X-Signature': hmacSignature,
                        },
                        body: JSON.stringify(payload),
                    });

                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || `HTTP error! status: ${response.status}`);
                    }

                    // Actualizar tokens
                    this.accessToken = data.accessToken;
                    this.refreshToken = data.refreshToken;
                    return data;
                } catch (error) {
                    throw new Error(`Error refrescando token: ${error.message}`);
                }
            }

            async verifyToken() {
                if (!this.accessToken) {
                    throw new Error('No hay access token disponible');
                }
                const url = `${this.apiUrl}/api/verify-token`;
                // El endpoint espera GET y el token en Authorization
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${this.accessToken}`,
                        'X-API-Key': this.apiKey,
                    },
                });
                const data = await response.json();
                return data;
            }
        }

        // Instancia del cliente OAuth
        const oauth = new Web3OAuth('test-api-key-123', 'test-api-secret-456', servidorUrl);

        function sanitizeLevelsForPayload(levels) {
            return (levels || []).map((level) => {
                const levelName = (level.levelName || '').trim() || 'custom';
                const network = (level.network || 'mainnet').trim().toLowerCase();
                const tokenRequirements = (level.tokenRequirements || [])
                    .map((token) => {
                        if (!token) return null;
                        const tokenMintAddress = (token.tokenMintAddress || '').trim();
                        if (!tokenMintAddress) return null;
                        const minAmountValue = token.minAmount === undefined ? '0' : String(token.minAmount).trim();
                        return {
                            tokenMintAddress,
                            minAmount: minAmountValue === '' ? '0' : minAmountValue,
                        };
                    })
                    .filter(Boolean);

                return {
                    levelName,
                    network: network === 'testnet' ? 'testnet' : 'mainnet',
                    tokenRequirements,
                };
            });
        }

        function updatePreviewAndOAuth() {
            const sanitized = sanitizeLevelsForPayload(customLevelsState);
            oauth.setCustomAccessLevels(sanitized);
            accessPreviewEl.textContent = JSON.stringify(sanitized, null, 2);
        }

        function removeLevel(index) {
            customLevelsState.splice(index, 1);
            renderLevels();
        }

        function removeTokenRequirement(levelIndex, tokenIndex) {
            const level = customLevelsState[levelIndex];
            if (!level || !Array.isArray(level.tokenRequirements)) return;
            level.tokenRequirements.splice(tokenIndex, 1);
            renderLevels();
        }

        function addTokenRequirement(levelIndex) {
            const level = customLevelsState[levelIndex];
            if (!level) return;
            if (!Array.isArray(level.tokenRequirements)) {
                level.tokenRequirements = [];
            }
            level.tokenRequirements.push({ tokenMintAddress: '', minAmount: '0' });
            renderLevels();
        }

        function createTokenRow(levelIndex, token, tokenIndex) {
            const row = document.createElement('div');
            row.className = 'token-row';

            const mintInput = document.createElement('input');
            mintInput.type = 'text';
            mintInput.placeholder = 'Mint del token';
            mintInput.value = token?.tokenMintAddress || '';
            mintInput.addEventListener('input', (event) => {
                customLevelsState[levelIndex].tokenRequirements[tokenIndex].tokenMintAddress = event.target.value;
                updatePreviewAndOAuth();
            });

            const amountInput = document.createElement('input');
            amountInput.type = 'text';
            amountInput.placeholder = 'Monto m√≠nimo (ej. 0.05)';
            amountInput.value = token?.minAmount !== undefined ? String(token.minAmount) : '0';
            amountInput.addEventListener('input', (event) => {
                customLevelsState[levelIndex].tokenRequirements[tokenIndex].minAmount = event.target.value;
                updatePreviewAndOAuth();
            });

            const removeTokenBtn = document.createElement('button');
            removeTokenBtn.type = 'button';
            removeTokenBtn.className = 'ghost-button small-button';
            removeTokenBtn.textContent = 'üóëÔ∏è Quitar token';
            removeTokenBtn.addEventListener('click', () => removeTokenRequirement(levelIndex, tokenIndex));

            row.appendChild(mintInput);
            row.appendChild(amountInput);
            row.appendChild(removeTokenBtn);

            return row;
        }

        function createLevelCard(level, index) {
            const card = document.createElement('div');
            card.className = 'level-card';

            const header = document.createElement('div');
            header.className = 'level-header';

            const title = document.createElement('h3');
            title.textContent = `Nivel ${index + 1}`;

            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'ghost-button small-button';
            deleteBtn.textContent = 'üóëÔ∏è Eliminar nivel';
            deleteBtn.addEventListener('click', () => removeLevel(index));

            header.appendChild(title);
            header.appendChild(deleteBtn);

            const nameLabel = document.createElement('label');
            nameLabel.textContent = 'Nombre del nivel';
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.placeholder = 'Ej. premium';
            nameInput.value = level?.levelName || '';
            nameInput.addEventListener('input', (event) => {
                customLevelsState[index].levelName = event.target.value;
                updatePreviewAndOAuth();
            });

            const networkLabel = document.createElement('label');
            networkLabel.textContent = 'Red';
            const networkSelect = document.createElement('select');
            const networks = [
                { value: 'mainnet', label: 'Mainnet' },
                { value: 'testnet', label: 'Testnet' },
            ];
            networks.forEach((option) => {
                const optionEl = document.createElement('option');
                optionEl.value = option.value;
                optionEl.textContent = option.label;
                networkSelect.appendChild(optionEl);
            });
            networkSelect.value = (level?.network || 'mainnet').toLowerCase();
            networkSelect.addEventListener('change', (event) => {
                customLevelsState[index].network = event.target.value;
                updatePreviewAndOAuth();
            });

            const tokenListWrapper = document.createElement('div');
            tokenListWrapper.className = 'token-list';

            const tokens = Array.isArray(level?.tokenRequirements) ? level.tokenRequirements : [];
            if (!tokens.length) {
                const emptyMessage = document.createElement('p');
                emptyMessage.style.fontStyle = 'italic';
                emptyMessage.style.color = '#616161';
                emptyMessage.textContent = 'No hay tokens requeridos para este nivel.';
                tokenListWrapper.appendChild(emptyMessage);
            } else {
                tokens.forEach((token, tokenIndex) => {
                    tokenListWrapper.appendChild(createTokenRow(index, token, tokenIndex));
                });
            }

            const addTokenBtn = document.createElement('button');
            addTokenBtn.type = 'button';
            addTokenBtn.className = 'outline-button small-button';
            addTokenBtn.textContent = '‚ûï A√±adir token requerido';
            addTokenBtn.addEventListener('click', () => addTokenRequirement(index));

            card.appendChild(header);
            card.appendChild(nameLabel);
            card.appendChild(nameInput);
            card.appendChild(networkLabel);
            card.appendChild(networkSelect);
            const tokensLabel = document.createElement('label');
            tokensLabel.textContent = 'Tokens requeridos';
            card.appendChild(tokensLabel);
            card.appendChild(tokenListWrapper);
            card.appendChild(addTokenBtn);

            return card;
        }

        function renderLevels() {
            levelsContainer.innerHTML = '';

            if (!customLevelsState.length) {
                const emptyState = document.createElement('div');
                emptyState.className = 'info-box';
                emptyState.textContent = 'No hay niveles configurados. A√±ade uno para comenzar.';
                levelsContainer.appendChild(emptyState);
            } else {
                customLevelsState.forEach((level, index) => {
                    levelsContainer.appendChild(createLevelCard(level, index));
                });
            }

            updatePreviewAndOAuth();
        }

        function addLevel() {
            const defaultLevel = {
                levelName: customLevelsState.length ? `nivel-${customLevelsState.length + 1}` : 'premium',
                network: 'mainnet',
                tokenRequirements: customLevelsState.length
                    ? []
                    : [{ tokenMintAddress: 'jupSoLaHXQiZZTSfEWMTRRgpnyFm8f6sZdosWBjx93v', minAmount: '0.00000001' }],
            };
            customLevelsState.push(defaultLevel);
            renderLevels();
        }

        addLevelBtn.addEventListener('click', addLevel);

        function initializeDynamicLevels() {
            customLevelsState = [
                {
                    levelName: 'premium',
                    network: 'mainnet',
                    tokenRequirements: [
                        { tokenMintAddress: 'jupSoLaHXQiZZTSfEWMTRRgpnyFm8f6sZdosWBjx93v', minAmount: '0.00000001' },
                    ],
                },
            ];
            renderLevels();
        }

        initializeDynamicLevels();

        // Funciones de manejo
        async function handleLogin() {
            showStatus('üîÑ Conectando a Phantom Wallet...', 'info');
            updatePreviewAndOAuth();
            
            try {
                // Conectar a Phantom Wallet real
                const publicKey = await oauth.connectWallet();
                showStatus(`üîó Wallet conectada: ${publicKey.substring(0, 8)}...`, 'success');
                
                // Autenticar con el servidor
                showStatus('‚úçÔ∏è Firmando mensaje de autenticaci√≥n...', 'info');
                const result = await oauth.authenticate(publicKey);
                
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('authenticated-section').style.display = 'block';
                document.getElementById('access-level').textContent = result.level || 'basic';
                document.getElementById('token-status').textContent = result.accessToken ? '‚úÖ Activo' : '‚ùå No disponible';
                document.getElementById('server-response').textContent = JSON.stringify(result, null, 2);
                
                showStatus('‚úÖ Autenticaci√≥n exitosa con Phantom Wallet!', 'success');
            } catch (error) {
                showStatus(`‚ùå Error: ${error.message}`, 'error');
                console.error('Error detallado:', error);
            }
        }
        async function handleRefresh() {
            showStatus('üîÑ Refrescando token y revalidando balances...', 'info');
            updatePreviewAndOAuth();
            
            try {
                const result = await oauth.refresh();
                
                // Actualizar la UI con los nuevos datos
                document.getElementById('access-level').textContent = result.level || 'basic';
                document.getElementById('token-status').textContent = result.accessToken ? '‚úÖ Activo (Refrescado)' : '‚ùå No disponible';
                document.getElementById('server-response').textContent = JSON.stringify(result, null, 2);
                
                showStatus('‚úÖ Token refrescado y balances revalidados', 'success');
            } catch (error) {
                showStatus(`‚ùå Error refrescando: ${error.message}`, 'error');
            }
        }
        async function handleVerify() {
            showStatus('üîÑ Verificando token...', 'info');
            
            try {
                const result = await oauth.verifyToken();
                document.getElementById('server-response').textContent = JSON.stringify(result, null, 2);
                if (result.valid){
                    document.getElementById('token-status').textContent = '‚úÖ Activo (Verificado)';
                } else {
                    document.getElementById('token-status').textContent = '‚ùå Inv√°lido';
                }
                showStatus('‚úÖ Token verificado', 'success');
            } catch (error) {
                showStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function handleLogout() {
            try {
                // Desconectar de Phantom si est√° disponible
                if (window.solana && window.solana.disconnect) {
                    await window.solana.disconnect();
                }
            } catch (error) {
                alert('Error desconectando wallet:', error);
            }
            
            oauth.accessToken = null;
            oauth.refreshToken = null;
            oauth.connectedPublicKey = null;
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('authenticated-section').style.display = 'none';
            showStatus('üëã Wallet desconectada y sesi√≥n cerrada', 'info');
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            const className = type === 'error' ? 'error-box' : 
                            type === 'success' ? 'success-box' : 'info-box';
            statusDiv.innerHTML = `<div class="${className}">${message}</div>`;
            
            // Limpiar despu√©s de 5 segundos
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 20000);
        }

        // Verificar servidor y Phantom Wallet al cargar
        window.addEventListener('load', async () => {
            // Verificar servidor
            try {
                const response = await fetch(`${servidorUrl}/health`);
                if (response.ok) {
                    showStatus('‚úÖ Servidor de testing conectado', 'success');
                } else {
                    throw new Error('Servidor no responde correctamente');
                }
            } catch (error) {
                showStatus('‚ö†Ô∏è Servidor de testing no encontrado. Ejecuta: node tests/start-test-server.js', 'error');
                return;
            }

            // Verificar Phantom Wallet
            if (window.solana && window.solana.isPhantom) {
                showStatus('‚úÖ Phantom Wallet detectada', 'success');
            } else {
                showStatus('‚ö†Ô∏è Phantom Wallet no encontrada. Inst√°lala desde https://phantom.app/', 'error');
            }
        });
    </script>
</body>
</html>