<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web3 OAuth Client Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            padding: 12px 24px;
            margin: 10px 5px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .primary { background-color: #512da8; color: white; }
        .secondary { background-color: #1976d2; color: white; }
        .danger { background-color: #d32f2f; color: white; }
        .info-box {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 15px 0;
        }
        .success-box {
            background-color: #e8f5e8;
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin: 15px 0;
        }
        .error-box {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
            padding: 15px;
            margin: 15px 0;
        }
        code {
            background-color: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Web3 OAuth Client Test</h1>
        
        <div class="info-box">
            <strong>Configuraci√≥n de Testing:</strong><br>
            Servidor: <code>http://localhost:3001</code><br>
            API Key: <code>test-api-key-123</code><br>
            API Secret: <code>test-api-secret-456</code>
        </div>

        <div id="login-section">
            <h2>Iniciar Sesi√≥n con Phantom Wallet</h2>
            <p>Esta demo se conecta realmente a tu Phantom Wallet para autenticaci√≥n Web3.</p>
            <div class="info-box">
                <strong>Requisitos:</strong><br>
                ‚Ä¢ Phantom Wallet instalada en tu navegador<br>
                ‚Ä¢ Al menos 0.00000001 SOL para nivel premium (opcional)<br>
                ‚Ä¢ Conexi√≥n a Internet para validar la firma
            </div>
            <button class="primary" onclick="handleLogin()">üîó Conectar con Phantom Wallet</button>
        </div>

        <div id="authenticated-section" style="display: none;">
            <h2>‚úÖ Sesi√≥n Activa</h2>
            <div class="success-box">
                <p><strong>Nivel de acceso:</strong> <span id="access-level">-</span></p>
                <p><strong>Access Token:</strong> <span id="token-status">-</span></p>
            </div>
            
            <h3>üí∞ Respuesta del Servidor</h3>
            <pre id="server-response" style="background: #f0f0f0; padding: 15px; border-radius: 5px; overflow-x: auto;"></pre>
            
            <div>
                <button class="secondary" onclick="handleRefresh()">üîÑ Refrescar Token</button>
                <button class="secondary" onclick="handleVerify()">‚úÖ Verificar Token</button>
                <button class="danger" onclick="handleLogout()">üö™ Cerrar Sesi√≥n</button>
            </div>
        </div>

        <div id="status"></div>
    </div>

    <script>
        // SDK Web3OAuth con conexi√≥n real a Phantom Wallet
        class Web3OAuth {
            constructor(apiKey, apiSecret, apiUrl) {
                this.apiKey = apiKey;
                this.apiSecret = apiSecret;
                this.apiUrl = apiUrl;
                this.accessToken = null;
                this.refreshToken = null;
                this.connectedPublicKey = null;
            }

            generateSignature(payload) {
                const nonce = Date.now().toString();
                const message = JSON.stringify(payload) + nonce;
                const signature = CryptoJS.HmacSHA256(message, this.apiSecret).toString(CryptoJS.enc.Base64);
                return { signature, nonce };
            }

            async connectWallet() {
                if (!window.solana) {
                    throw new Error('Phantom Wallet no encontrada. Por favor instala Phantom desde https://phantom.app/');
                }

                try {
                    const response = await window.solana.connect();
                    this.connectedPublicKey = response.publicKey.toString();
                    return this.connectedPublicKey;
                } catch (error) {
                    throw new Error(`Error conectando a Phantom: ${error.message}`);
                }
            }

            async authenticate(publicKey) {
                const message = `Autenticaci√≥n para ${this.apiKey} en ${new Date().toISOString()}`;
                
                try {
                    // Firmar mensaje con Phantom Wallet
                    const encodedMessage = new TextEncoder().encode(message);
                    const signedMessage = await window.solana.signMessage(encodedMessage, 'utf8');
                    
                    const payload = {
                        apiKey: this.apiKey,
                        publicKey,
                        signature: Array.from(signedMessage.signature), // Convertir a array
                        message,
                    };

                    const { signature: hmacSignature, nonce } = this.generateSignature(payload);

                    const response = await fetch(`${this.apiUrl}/api/authenticate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': this.apiKey,
                            'X-Nonce': nonce,
                            'X-Signature': hmacSignature,
                        },
                        body: JSON.stringify(payload),
                    });

                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || `HTTP error! status: ${response.status}`);
                    }

                    this.accessToken = data.accessToken;
                    this.refreshToken = data.refreshToken;
                    return data;
                } catch (error) {
                    throw new Error(`Error en autenticaci√≥n: ${error.message}`);
                }
            }

            async verifyToken() {
                if (!this.accessToken) {
                    throw new Error('No hay access token disponible');
                }

                const payload = { accessToken: this.accessToken };
                const { signature: hmacSignature, nonce } = this.generateSignature(payload);

                const response = await fetch(`${this.apiUrl}/api/verify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': this.apiKey,
                        'X-Nonce': nonce,
                        'X-Signature': hmacSignature,
                    },
                    body: JSON.stringify(payload),
                });

                return await response.json();
            }
        }

        // Instancia del cliente OAuth
        const oauth = new Web3OAuth('test-api-key-123', 'test-api-secret-456', 'http://localhost:3001');

        // Funciones de manejo
        async function handleLogin() {
            showStatus('üîÑ Conectando a Phantom Wallet...', 'info');
            
            try {
                // Conectar a Phantom Wallet real
                const publicKey = await oauth.connectWallet();
                showStatus(`üîó Wallet conectada: ${publicKey.substring(0, 8)}...`, 'success');
                
                // Autenticar con el servidor
                showStatus('‚úçÔ∏è Firmando mensaje de autenticaci√≥n...', 'info');
                const result = await oauth.authenticate(publicKey);
                
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('authenticated-section').style.display = 'block';
                document.getElementById('access-level').textContent = result.level || 'basic';
                document.getElementById('token-status').textContent = result.accessToken ? '‚úÖ Activo' : '‚ùå No disponible';
                document.getElementById('server-response').textContent = JSON.stringify(result, null, 2);
                
                showStatus('‚úÖ Autenticaci√≥n exitosa con Phantom Wallet!', 'success');
            } catch (error) {
                showStatus(`‚ùå Error: ${error.message}`, 'error');
                console.error('Error detallado:', error);
            }
        }

        async function handleVerify() {
            showStatus('üîÑ Verificando token...', 'info');
            
            try {
                const result = await oauth.verifyToken();
                document.getElementById('server-response').textContent = JSON.stringify(result, null, 2);
                showStatus('‚úÖ Token verificado', 'success');
            } catch (error) {
                showStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        function handleRefresh() {
            showStatus('‚ö†Ô∏è Refresh no implementado en el servidor de testing', 'info');
        }

        async function handleLogout() {
            try {
                // Desconectar de Phantom si est√° disponible
                if (window.solana && window.solana.disconnect) {
                    await window.solana.disconnect();
                }
            } catch (error) {
                console.log('Error desconectando wallet:', error);
            }
            
            oauth.accessToken = null;
            oauth.refreshToken = null;
            oauth.connectedPublicKey = null;
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('authenticated-section').style.display = 'none';
            showStatus('üëã Wallet desconectada y sesi√≥n cerrada', 'info');
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            const className = type === 'error' ? 'error-box' : 
                            type === 'success' ? 'success-box' : 'info-box';
            statusDiv.innerHTML = `<div class="${className}">${message}</div>`;
            
            // Limpiar despu√©s de 5 segundos
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 5000);
        }

        // Verificar servidor y Phantom Wallet al cargar
        window.addEventListener('load', async () => {
            // Verificar servidor
            try {
                const response = await fetch('http://localhost:3001/health');
                if (response.ok) {
                    showStatus('‚úÖ Servidor de testing conectado', 'success');
                } else {
                    throw new Error('Servidor no responde correctamente');
                }
            } catch (error) {
                showStatus('‚ö†Ô∏è Servidor de testing no encontrado. Ejecuta: node tests/start-test-server.js', 'error');
                return;
            }

            // Verificar Phantom Wallet
            if (window.solana && window.solana.isPhantom) {
                showStatus('‚úÖ Phantom Wallet detectada', 'success');
            } else {
                showStatus('‚ö†Ô∏è Phantom Wallet no encontrada. Inst√°lala desde https://phantom.app/', 'error');
            }
        });
    </script>
</body>
</html>